> [!TIP]  
> [Ver video](https://youtu.be/9LlG6f96CCU)

DHCP es un protocolo de capa de aplicación, lo que significa que se basa en las capas de transporte, red, enlace de datos y capas físicas para funcionar. Pero te habrás dado cuenta de que la finalidad de DHCP es ayudar a configurar la capa de red en sí. Veamos exactamente cómo funciona DHCP y cómo logra las comunicaciones sin una configuración de capa de red implementada. Advertencia, se avecinan cosas de cerebritos.

El proceso por el cual un cliente configurado para usar DHCP intenta obtener información de la configuración de red se conoce como detección DHCP. El proceso de detección DHCP tiene cuatro pasos.

Primero, tenemos el paso de detección del servidor. Los clientes DHCP envían lo que se conoce como un mensaje de detección DHCP a la red. Como la máquina no tiene una IP y no conoce la IP del servidor DHCP, se forma, en su lugar, un mensaje de difusión especialmente diseñado. DHCP escucha en el puerto UDP 67 y los mensajes de detección DHCP siempre se envían desde el puerto UDP 68. Así que el mensaje DHCPDISCOVER se encapsula en un datagrama UDP con un puerto de destino de 67 y un puerto de origen de 68. Esto, luego, se encapsula dentro de un datagrama IP con una IP de destino de 255.255.255.255, y una IP de origen de 0.0.0.0. Este mensaje de difusión se entregará a cada nodo en la red de área local. Y si hay un servidor DHCP presente, recibirá este mensaje.

A continuación, el servidor DHCP examinará su propia configuración y tomará una decisión sobre qué dirección IP ofrecer al cliente, si es que hay alguna. Esto dependerá de si está configurado para funcionar con asignación de direcciones dinámica, automática o fija. La respuesta se enviará como un mensaje DHCPOFFER con un puerto de destino de 68, un puerto fuente de 67, una IP de difusión de destino de 255.255.255.255 y su IP real como la fuente. Como DHCPOFFER es también una difusión, llegará a cada máquina en la red. El cliente original reconocerá que este mensaje estaba destinado a sí mismo. Esto es porque DHCPOFFER tiene el campo que especifica la dirección MAC del cliente que envió el mensaje DHCPDISCOVER.

La máquina cliente ahora procesará este DHCPOFFER para ver qué dirección IP se le ofrece. Técnicamente, un cliente DHCP podría rechazar esta oferta. Es totalmente posible que múltiples servidores DHCP se ejecuten en la misma red y que un cliente DHCP esté configurado solo para responder a una oferta de un IP dentro de un cierto rango. Pero esto no es frecuente. Más a menudo, el cliente DHCP responderá al mensaje DHCPOFFER con un mensaje DHCPREQUEST. Este mensaje dice esencialmente: "Sí, me gustaría tener una de las IP que me ofreces". Como la IP no se asignó todavía, esto se envía de nuevo desde una IP de 0.0.0.0 a la IP de difusión 255.255.255.255.

Por último, el servidor DHCP recibe el mensaje DHCPREQUEST y responde con un DHCPACK o mensaje de acuse de recibo de DHCP. Este mensaje se envía de nuevo a una IP de difusión 255.255.255.255, y con una IP de origen correspondiente a la IP real del servidor DHCP. Una vez más, el cliente DHCP reconocerá que este mensaje estaba destinado a sí mismo porque tenía incluida su dirección MAC en uno de los campos.

Ahora, la pila de redes en la computadora cliente puede usar la información de configuración que el servidor DHCP le presentó para establecer su propia configuración de capa de red. En este punto, la computadora que actúa como cliente DHCP debería tener toda la información que necesita para funcionar por completo en la red a la que está conectada. Toda esta configuración se conoce como concesión DHCP ya que incluye un tiempo de expiración. Una concesión DHCP puede durar días o solo un corto período de tiempo. Una vez que la concesión expire, el cliente DHCP tendrá que negociar una nueva. Para ello, debe volver a realizar todo el proceso de detección DHCP. Un cliente también puede liberar su concesión al servidor DHCP, lo que hará cuando se desconecte de la red. Esto permitirá que el servidor DHCP devuelva la dirección IP que había sido asignada a su conjunto de direcciones IP disponibles.

Ya viste DHCP en acción. Ahora, tenemos un breve cuestionario para ti. Cuando hayas terminado, será momento de aprender los fundamentos de NAT.
